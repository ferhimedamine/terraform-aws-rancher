image: alpine:latest
stages:
  - test
  - tf_apply
  - tf_cleanup
test_tf:
  stage: test
  script:
    - terraform validate ./terraform/aws/rancher/
    - go test ./... -v timeout 60
  except:
    variables:
      - $CI_COMMIT_MESSAGE =~ /#skip_test/
terraform_apply:
  stage: tf_apply
  script:
    - "echo  terraform apply..."
  only:
    refs:
      - /^feat.*$/
    variables:
      - $CI_COMMIT_MESSAGE =~ /#tf_apply/
  except:
    refs:
      - master

terraform_cleanup:
  stage: tf_cleanup
  script:
    - "echo terraform destroy..."
  only:
    variables:
      - $CI_COMMIT_MESSAGE =~ /#tf_apply/
  when: on_failure